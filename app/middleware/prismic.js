var Prismic         = require('prismic.io').Prismic;
var config          = require('../../config');

// Router middleware that adds a Prismic context to the res object
module.exports = function(req, res, next) {
    Prismic.Api(config.apiEndpoint, function(err, Api) {
        if (err) {
            console.log('prismic middleware ERROR');
            return res.send(500, 'Error 500: ' + err.message);
        }

        var ref = req.query['ref'] || Api.master();
        var ctx = {
            api:        Api,
            ref:        ref,
            maybeRef:   ref == Api.master() ? undefined : ref,

            oauth: function() {
                var token = accessToken;
                return {
                    accessToken:            token,
                    hasPrivilegedAccess:    !!token
                }
            }
        };

        res.locals.ctx = ctx;
        next();

    }, config.accessToken);
};
